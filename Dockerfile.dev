# Development Dockerfile for Medplum Server
# This builds the server and its dependencies from source for local development
# Unlike the production Dockerfile, this includes the full build process

FROM node:24-slim AS builder

# Install build dependencies
RUN apt-get update && \
    apt-get install -y git python3 make g++ && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src/medplum

# Copy package files for dependency installation
COPY package*.json ./
COPY turbo.json ./
COPY tsconfig.json ./

# Copy all package.json files from the monorepo
COPY packages/core/package.json ./packages/core/
COPY packages/fhirtypes/package.json ./packages/fhirtypes/
COPY packages/definitions/package.json ./packages/definitions/
COPY packages/generator/package.json ./packages/generator/
COPY packages/mock/package.json ./packages/mock/
COPY packages/fhir-router/package.json ./packages/fhir-router/
COPY packages/bot-layer/package.json ./packages/bot-layer/
COPY packages/ccda/package.json ./packages/ccda/
COPY packages/hl7/package.json ./packages/hl7/
COPY packages/server/package.json ./packages/server/

# Install all dependencies
RUN npm install

# Copy all source code
COPY packages/core/ ./packages/core/
COPY packages/fhirtypes/ ./packages/fhirtypes/
COPY packages/definitions/ ./packages/definitions/
COPY packages/generator/ ./packages/generator/
COPY packages/mock/ ./packages/mock/
COPY packages/fhir-router/ ./packages/fhir-router/
COPY packages/bot-layer/ ./packages/bot-layer/
COPY packages/ccda/ ./packages/ccda/
COPY packages/hl7/ ./packages/hl7/
COPY packages/server/ ./packages/server/

# Build all dependencies and the server
RUN npm run build --workspace=@medplum/fhirtypes && \
    npm run build --workspace=@medplum/definitions && \
    npm run build --workspace=@medplum/core && \
    npm run build --workspace=@medplum/generator && \
    npm run build --workspace=@medplum/mock && \
    npm run build --workspace=@medplum/fhir-router && \
    npm run build --workspace=@medplum/bot-layer && \
    npm run build --workspace=@medplum/ccda && \
    npm run build --workspace=@medplum/hl7 && \
    npm run build --workspace=@medplum/server

# Production stage
FROM node:24-slim

ENV NODE_ENV=production

WORKDIR /usr/src/medplum

# Copy package files
COPY package*.json ./
COPY turbo.json ./

# Copy built artifacts from builder
COPY --from=builder /usr/src/medplum/packages/core/package.json ./packages/core/
COPY --from=builder /usr/src/medplum/packages/core/dist/ ./packages/core/dist/
COPY --from=builder /usr/src/medplum/packages/fhirtypes/package.json ./packages/fhirtypes/
COPY --from=builder /usr/src/medplum/packages/fhirtypes/dist/ ./packages/fhirtypes/dist/
COPY --from=builder /usr/src/medplum/packages/definitions/package.json ./packages/definitions/
COPY --from=builder /usr/src/medplum/packages/definitions/dist/ ./packages/definitions/dist/
COPY --from=builder /usr/src/medplum/packages/generator/package.json ./packages/generator/
COPY --from=builder /usr/src/medplum/packages/generator/dist/ ./packages/generator/dist/
COPY --from=builder /usr/src/medplum/packages/mock/package.json ./packages/mock/
COPY --from=builder /usr/src/medplum/packages/mock/dist/ ./packages/mock/dist/
COPY --from=builder /usr/src/medplum/packages/fhir-router/package.json ./packages/fhir-router/
COPY --from=builder /usr/src/medplum/packages/fhir-router/dist/ ./packages/fhir-router/dist/
COPY --from=builder /usr/src/medplum/packages/bot-layer/package.json ./packages/bot-layer/
COPY --from=builder /usr/src/medplum/packages/bot-layer/dist/ ./packages/bot-layer/dist/
COPY --from=builder /usr/src/medplum/packages/ccda/package.json ./packages/ccda/
COPY --from=builder /usr/src/medplum/packages/ccda/dist/ ./packages/ccda/dist/
COPY --from=builder /usr/src/medplum/packages/hl7/package.json ./packages/hl7/
COPY --from=builder /usr/src/medplum/packages/hl7/dist/ ./packages/hl7/dist/
COPY --from=builder /usr/src/medplum/packages/server/package.json ./packages/server/
COPY --from=builder /usr/src/medplum/packages/server/dist/ ./packages/server/dist/

# Install only production dependencies
RUN npm install --omit=dev && \
    groupadd -r medplum && \
    useradd -r -g medplum medplum && \
    chown -R medplum:medplum /usr/src/medplum

EXPOSE 5000 8103

# Switch to the non-root user
USER medplum

ENTRYPOINT [ "node", "--require", "./packages/server/dist/otel/instrumentation.js", "packages/server/dist/index.js" ]
